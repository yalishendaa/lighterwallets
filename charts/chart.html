<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { 
      margin: 0; 
      background: #000; 
      font-family: 'Segoe UI', sans-serif;
    }
    #chart { 
      width: 800px; 
      height: 400px; 
      position: relative; 
    }
    #info {
      position: absolute; 
      top: 10px; 
      left: 10px;
      color: #fff; 
      font-size: 14px; 
      font-weight: 600;
      z-index: 10;
      background: rgba(0,0,0,0.8);
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #333;
    }
  </style>
</head>
<body>
  <div id="chart">
    <div id="info">__TICKER__ __INTERVAL__ — __EXCHANGE__</div>
  </div>
  <script>
    const candles = __DATA__
    const avgPrice = __AVG_PRICE__
    const positions = __POSITIONS__

    if (!candles || !Array.isArray(candles) || candles.length === 0) {
      document.body.innerHTML = '<div style="color: white; text-align: center; padding: 50px;">No chart data available</div>'
    } else {
      const high = Math.max(...candles.map(c => c.high))
      const low = Math.min(...candles.map(c => c.low))

      const chart = LightweightCharts.createChart(
        document.getElementById('chart'),
        {
          layout: { 
            background: { color: '#000' }, 
            textColor: '#ccc' 
          },
          grid: { 
            vertLines: { color: '#222' }, 
            horzLines: { color: '#222' } 
          },
          timeScale: { 
            timeVisible: true,
            secondsVisible: false,
            borderColor: '#444',
            rightOffset: 15
          },
          priceScale: { 
            borderColor: '#444', 
            scaleMargins: { top: 0.1, bottom: 0.1 }
          }
        }
      )

      // Добавляем свечи
      const candlestickSeries = chart.addCandlestickSeries({
        upColor: '#26a69a',
        downColor: '#ef5350',
        borderVisible: false,
        wickUpColor: '#26a69a',
        wickDownColor: '#ef5350'
      })

      // Конвертируем время для LightweightCharts
      const convertedCandles = candles.map(d => ({
        time: d.time, // уже в секундах
        open: d.open,
        high: d.high,
        low: d.low,
        close: d.close
      }))

      candlestickSeries.setData(convertedCandles)

      // Добавляем среднюю цену если есть
      if (avgPrice && avgPrice > 0) {
        const avgPriceSeries = chart.addLineSeries({
          color: '#ffeb3b',
          lineWidth: 2,
          lineStyle: LightweightCharts.LineStyle.Dashed,
          title: 'Avg Price'
        })

        const avgPriceData = convertedCandles.map(candle => ({
          time: candle.time,
          value: avgPrice
        }))

        avgPriceSeries.setData(avgPriceData)
      }

      // Добавляем маркеры позиций
      if (positions && Array.isArray(positions) && positions.length > 0) {
        const markers = positions.map(pos => ({
          time: Math.floor(new Date(pos.time).getTime() / 1000),
          position: pos.type === 'buy' ? 'belowBar' : 'aboveBar',
          color: pos.type === 'buy' ? '#26a69a' : '#ef5350',
          shape: pos.type === 'buy' ? 'arrowUp' : 'arrowDown',
          text: pos.type === 'buy' ? `B` : `S`,
          size: 2
        }))

        candlestickSeries.setMarkers(markers)
      }

      // Настраиваем масштаб
      chart.priceScale('right').applyOptions({
        autoScale: false,
        minValue: low * 0.99,
        maxValue: high * 1.01
      })

      chart.timeScale().fitContent()
    }
  </script>
</body>
</html>
